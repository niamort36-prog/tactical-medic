<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Medic Card V20 - Data Update</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        /* --- CHARTE GRAPHIQUE --- */
        :root { 
            --bg-dark: #121212; 
            --text-main: #f0f0f0;
            --text-dim: #888;
            --accent-red: #d32f2f; 
            --accent-orange: #f57c00; 
            --accent-green: #388e3c;
            --accent-blue: #1976d2;
            --accent-black: #111111;
            --font-stack: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --card-bg: #1c1c1c;
        }

        body { 
            font-family: var(--font-stack);
            background-color: var(--bg-dark); 
            color: var(--text-main);
            margin: 0; padding: 0; 
            height: 100vh; display: flex; flex-direction: column;
            overflow: hidden;
        }

        .topo-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: url('fond-topo.png'); 
            background-size: cover; background-position: center; opacity: 0.3;
        }

        /* --- HEADER --- */
        header {
            padding: 15px 20px; display: flex; align-items: center; justify-content: space-between;
            z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .app-title-container { flex-grow: 1; }
        .app-title { font-size: 1.1em; font-weight: 800; text-transform: uppercase; color: #fff; letter-spacing: 0.5px;}
        .mode-subtitle { font-size: 0.75em; color: var(--text-dim); display: block; margin-top: 2px;}
        .header-actions { display: flex; gap: 10px; }
        .header-btn {
            background: rgba(30,30,30,0.8); border: 1px solid #444; color: white; border-radius: 8px; 
            width: 45px; height: 45px; font-size: 1.4em; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* --- √âCRANS --- */
        .screen { display: none; padding: 20px; flex-grow: 1; overflow-y: auto; padding-bottom: 100px; z-index: 5; }
        .screen.active { display: block; }
        .flex-center { display: none; flex-direction: column; align-items: center; justify-content: center; height: 85%; text-align: center; z-index: 5; position: relative; }
        .flex-center.active { display: flex; }

        /* --- CONTAINER BOUTONS ACCUEIL --- */
        .buttons-wrapper {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            margin-bottom: 20px; width: 100%; justify-content: flex-start;
            max-height: 65vh; overflow-y: auto; overflow-x: visible;
            padding: 40px 20px; box-sizing: border-box;
        }
        .buttons-wrapper::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- MIXINS BOUTONS --- */
        .btn-container-shared { position: relative; width: 180px; height: 180px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; margin: 10px 0; }
        .btn-core-shared { width: 150px; height: 150px; border-radius: 50%; background: rgba(20, 20, 20, 0.7); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; backdrop-filter: blur(5px); padding: 0; overflow: hidden; position: relative; z-index: 2; }
        .btn-core-shared:active { transform: scale(0.95); }
        .btn-label { position: absolute; bottom: 25px; width: 100%; text-align: center; font-size: 0.8em; font-weight: 800; color: white; text-shadow: 0 1px 3px black; pointer-events: none; text-transform: uppercase; }

        .pulse-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--accent-red); box-shadow: 0 0 40px rgba(211, 47, 47, 0.6); animation: pulse 2.5s infinite; }
        .main-btn { border: 2px solid rgba(211, 47, 47, 0.3); }
        .pulse-ring-blast { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--accent-orange); box-shadow: 0 0 40px rgba(245, 124, 0, 0.6); animation: pulse 3s infinite; }
        .blast-btn { border: 2px solid rgba(245, 124, 0, 0.3); }
        .pulse-ring-custom { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--accent-green); box-shadow: 0 0 40px rgba(56, 142, 60, 0.6); animation: pulse 3s infinite; }
        .custom-btn-style { border: 2px solid rgba(56, 142, 60, 0.3); }

        .icon-wounded { width: 70%; height: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(211,47,47,0.8)); }
        .icon-blast { width: 65%; height: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(245, 124, 0, 0.8)); }
        .icon-custom { width: 60%; height: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(56, 142, 60, 0.8)); }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.8; box-shadow: 0 0 0 0 currentColor; }
            70% { transform: scale(1.1); opacity: 0; box-shadow: 0 0 0 40px rgba(0,0,0,0); }
            100% { transform: scale(0.95); opacity: 0; }
        }

        .text-diagnostic { font-size: 1.2em; font-weight: 800; text-transform: uppercase; margin-bottom: 5px; color: white; letter-spacing: 1px; text-shadow: 0 2px 5px rgba(0,0,0,0.5);}
        .text-sub { font-size: 0.9em; color: #aaa; margin-bottom: 20px; }
        .text-count { font-weight: bold; color: #ccc; padding: 6px 15px; border-radius: 30px; background: rgba(0,0,0,0.6); border: 1px solid #444; font-size: 0.8em;}

        /* --- UI BUILDER --- */
        .builder-list { display: flex; flex-direction: column; gap: 10px; }
        .builder-item { background: #222; border: 1px solid #444; border-radius: 8px; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        .form-input { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1em; }
        
        .matos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-height: 200px; overflow-y: auto; background: #111; padding: 10px; border: 1px solid #444; border-radius: 4px; }
        .matos-check { display: flex; align-items: center; gap: 8px; padding: 5px; background: #222; border-radius: 4px; font-size: 0.9em; }
        
        .card-preview-mini { background: #151515; padding: 10px; border-left: 4px solid #555; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }

        /* --- MARCH & RESULT --- */
        .march-list { list-style: none; padding: 0; text-align: left; font-size: 2em; font-weight: 900; color: var(--accent-orange); text-shadow: 0 0 10px rgba(0,0,0,0.8); }
        .march-list li { margin-bottom: 10px; opacity: 0; animation: fadeIn 0.5s forwards; }
        .march-list li:nth-child(1) { animation-delay: 0.2s; } .march-list li:nth-child(2) { animation-delay: 1.0s; } .march-list li:nth-child(3) { animation-delay: 1.8s; } .march-list li:nth-child(4) { animation-delay: 2.6s; } .march-list li:nth-child(5) { animation-delay: 3.4s; }
        @keyframes fadeIn { to { opacity: 1; } }

        .result-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);}
        .tac-card { background: var(--card-bg); width: 85%; max-width: 380px; border-radius: 12px; padding: 25px; text-align: left; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.8); border: 3px solid #333; transition: all 0.3s ease; overflow: hidden; }
        .card-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85em; text-transform: uppercase; color: white; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; width: fit-content; }
        .card-title { font-size: 1.5em; font-weight: 800; color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; line-height: 1.2; }
        .card-label { font-size: 0.75em; color: #777; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; margin-top: 20px; display: block; }
        .card-desc { font-size: 1.2em; color: #ddd; font-weight: 500; }
        .card-box { border: 1px solid #444; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; color: #fff; font-size: 1em; line-height: 1.5; }
        .btn-card-action { margin-top: 30px; width: 100%; padding: 16px; border-radius: 8px; border: none; font-weight: bold; font-size: 1em; cursor: pointer; text-transform: uppercase; color: white; }

        /* --- DANGER ZONE & DEATH --- */
        #danger-zone-container { display: none; margin-top: 20px; background: rgba(85, 0, 0, 0.3); border: 1px solid #d32f2f; border-radius: 8px; padding: 15px; text-align: center; }
        .invisible-timer-warning { color: #ff3333; font-weight: 900; font-size: 1em; text-transform: uppercase; animation: blinkFast 0.8s infinite; }
        @keyframes blinkFast { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        
        #death-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; text-align: center; }
        .skull-icon { font-size: 5em; margin-bottom: 20px; text-shadow: 0 0 20px red; }
        .death-text { color: #d32f2f; font-size: 2.2em; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; }

        /* --- R√âGLAGES --- */
        .box { background: rgba(30, 30, 30, 0.95); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        h3 { margin-top: 0; color: var(--accent-orange); font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 8px; letter-spacing: 1px;}
        .full-width { width: 100%; padding: 12px; border-radius: 6px; border: 1px solid #444; font-size: 1em; background: #111; color: white;}
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        
        /* Item d√©sactiv√© */
        .check-item.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        
        .btn-mini { width: 32px; height: 32px; border-radius: 4px; border: none; font-weight: bold; background: #444; color: white; cursor:pointer;}
        .btn-view { background: #1976d2; color: white; margin-right: 5px; font-size: 1.2em; display: flex; align-items: center; justify-content: center;}
        
        /* Compteur dans les r√©glages */
        .settings-count-display { 
            text-align: center; color: var(--accent-green); font-weight: 800; font-size: 1.1em; 
            padding: 10px; margin-bottom: 15px; border: 1px solid var(--accent-green); 
            border-radius: 8px; background: rgba(56, 142, 60, 0.1); 
        }

        .settings-footer { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; z-index: 20; border-top: 1px solid #333; background: #121212;}
        .footer-btn { flex: 1; padding: 20px; border: none; font-weight: bold; font-size: 1em; cursor: pointer; text-transform: uppercase; }
        .btn-cancel { background: #1a1a1a; color: #888; }
        .btn-save { background: var(--accent-green); color: white; }
        .btn-action { width: 100%; padding: 15px; margin-top: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase;}
        .btn-share { background: #444; border: 1px solid #666; } .btn-scan { background: #1976d2; }
        #qr-display, #reader { margin-top: 15px; text-align: center; display: none; }
        #qr-image { border: 5px solid white; max-width: 180px; }
        
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .modal-content { background-color: #222; color: #eee; margin: 15% auto; padding: 20px; border-radius: 8px; width: 85%; max-width: 400px; border: 1px solid #444; max-height: 70vh; overflow-y: auto;}
        .preview-card { border: 1px solid #444; padding: 10px; margin-bottom: 10px; border-radius: 4px; background: #1a1a1a; border-left: 4px solid #333;}
    </style>
</head>
<body>

    <div class="topo-bg"></div>

    <header>
        <div class="app-title-container">
            <div class="app-title">Tactical Medic Card</div>
            <span id="top-indicator" class="mode-subtitle">Mode Classique</span>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="ouvrirBuilder()">‚úèÔ∏è</button>
            <button class="header-btn" onclick="ouvrirReglages()">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="screen-game" class="flex-center active">
        <div id="dynamic-buttons-container" class="buttons-wrapper">
            <div class="btn-circle-container btn-container-shared">
                <div class="pulse-ring"></div>
                <button class="main-btn btn-core-shared" onclick="lancerSequenceTirage('bille')">
                    <img src="picto-blesse.png" class="icon-wounded" alt="Bille">
                </button>
                <div class="btn-label">Balistique</div>
            </div>
            <div id="explosion-trigger-container" class="blast-container btn-container-shared" style="display:none;">
                <div class="pulse-ring-blast"></div>
                <button class="blast-btn btn-core-shared" onclick="lancerSequenceTirage('explosion')">
                    <img src="btn-explosion.png" class="icon-blast" alt="Explosion">
                </button>
                <div class="btn-label">Explosion</div>
            </div>
        </div>
        <div class="text-diagnostic">DIAGNOSTIC</div>
        <div class="text-sub">S√©lectionnez la menace</div>
        <div class="text-count" id="info-deck">Chargement...</div>
    </div>

    <div id="screen-builder" class="screen">
        <h2 style="margin-top:40px; border-bottom:1px solid #444; padding-bottom:10px;">MES PAQUETS</h2>
        <button class="btn-action btn-scan" onclick="creerNouveauPaquet()">+ CR√âER UN PAQUET</button>
        <div id="custom-decks-list" class="builder-list" style="margin-top:20px;"></div>
        <div style="height: 50px;"></div>
        <button class="btn-action btn-share" onclick="retourAccueil()">RETOUR ACCUEIL</button>
    </div>

    <div id="screen-deck-edit" class="screen">
        <h2 style="margin-top:40px;">√âDITION PAQUET</h2>
        <div class="box">
            <div class="form-group"><label class="form-label">Nom du Paquet</label><input type="text" id="deck-name" class="form-input" placeholder="Ex: Sc√©nario Zombie"></div>
            <div class="check-item"><span>Afficher bouton sur l'accueil</span><input type="checkbox" id="deck-show-home" style="transform:scale(1.5); accent-color: var(--accent-green);"></div>
        </div>
        <div class="box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;"><h3>CARTES DU PAQUET</h3><button class="btn-mini btn-view" onclick="ajouterCarteCustom()" style="background:var(--accent-green); width:auto; padding:0 10px;">+ AJOUTER</button></div>
            <div id="deck-cards-list"></div>
        </div>
        <div class="settings-footer"><button class="footer-btn btn-cancel" onclick="ouvrirBuilder()">RETOUR</button><button class="footer-btn btn-save" onclick="sauvegarderPaquetCourant()">ENREGISTRER</button><button class="footer-btn" style="background:#d32f2f; color:white; max-width:60px;" onclick="supprimerPaquetCourant()">üóëÔ∏è</button></div>
    </div>

    <div id="screen-card-edit" class="screen">
        <h2 style="margin-top:40px;">√âDITION CARTE</h2>
        <div class="box">
            <div class="form-group"><label class="form-label">Cat√©gorie / Gravit√©</label><select id="card-gravity" class="form-input" onchange="updateCardColorPreview()"><option value="D√âC√àS">‚ö´ D√âC√àS</option><option value="Critique">üî¥ CRITIQUE</option><option value="Grave">üü† GRAVE</option><option value="L√©g√®re">üü¢ L√âG√àRE</option><option value="Sp√©cial">üü£ SP√âCIAL</option></select></div>
            <div class="form-group"><label class="form-label">Titre</label><input type="text" id="card-title" class="form-input" placeholder="Ex: Morsure Infect√©e"></div>
            <div class="form-group"><label class="form-label">Zone</label><input type="text" id="card-zone" class="form-input" placeholder="Ex: Bras"></div>
            <div class="form-group"><label class="form-label">Description (Narratif)</label><textarea id="card-effect" class="form-input" rows="3" placeholder="Ex: Nettoyer la plaie..."></textarea></div>
            
            <div class="form-group">
                <label class="form-label" style="color:var(--accent-blue)">MAT√âRIEL DE SOINS REQUIS</label>
                <div id="card-matos-list" class="matos-grid"></div>
                <div style="display:flex; gap:5px; margin-top:10px;">
                    <input type="text" id="new-matos-name" class="form-input" placeholder="Nouveau (ex: Antidote)">
                    <button class="btn-mini" onclick="addNewMatosToEditor()" style="width:50px; background:var(--accent-blue)">+</button>
                </div>
            </div>
        </div>
        <div class="settings-footer"><button class="footer-btn btn-cancel" onclick="annulerEditionCarte()">ANNULER</button><button class="footer-btn btn-save" onclick="validerCarte()">VALIDER</button></div>
    </div>

    <div id="screen-march" class="flex-center"><ul class="march-list"><li>M - Massive Bleeding</li><li>A - Airways</li><li>R - Respiration</li><li>C - Circulation</li><li>H - Head / Hypothermia</li></ul><div style="margin-top:40px; font-size:0.9em; color:#888; text-transform:uppercase; letter-spacing:2px;">Analyse en cours...</div></div>
    <div id="screen-result" class="screen" style="padding:0; overflow:hidden;"><div class="result-wrapper"><div id="ui-card" class="tac-card"><div id="death-overlay"><div class="skull-icon">üíÄ</div><div class="death-text">MORT AU COMBAT</div><div style="color:#aaa; margin-top:10px;">Temps √©coul√© - H√©morragie fatale</div><button class="btn-card-action" style="background:#555; margin-top:30px;" onclick="retourAccueil()">Fermer le dossier</button></div><div id="badge-gravite" class="card-badge"><span>‚ö†Ô∏è</span> <span id="txt-gravite">GRAVE</span></div><div class="card-title"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg><span id="txt-zone">Jambe droite touch√©e</span></div><span class="card-label">DESCRIPTION</span><div id="txt-titre" class="card-desc">Fracture</div><span class="card-label">TRAITEMENT REQUIS</span><div id="txt-soins" class="card-box">Soins...</div><div id="danger-zone-container"><div class="invisible-timer-warning">‚ö†Ô∏è H√âMORRAGIE ACTIVE<br>URGENCE VITALE</div></div><button id="btn-card" class="btn-card-action" onclick="actionPrincipale()">Nouveau Diagnostic</button></div></div></div>

    <div id="screen-settings" class="screen">
        <h2 style="border-bottom:1px solid #444; padding-bottom:10px; margin-bottom:20px; margin-top:40px;">R√âGLAGES MISSION</h2>
        <div class="box"><h3>Mode de Jeu</h3><select id="select-mode" class="full-width" onchange="changerModeMenu(this.value)"></select></div>
        <div id="box-explosion-opt" class="box" style="border: 1px solid var(--accent-orange); display:none;"><h3 style="color:var(--accent-orange)">üí• Pack Explosion</h3><div class="check-item"><span>Activer Cartes Explosion</span><input type="checkbox" id="chk-explosion" onchange="toggleExplosion()" style="transform:scale(1.5); accent-color: var(--accent-orange);"></div></div>
        <div class="box" style="border: 1px solid var(--accent-red);"><h3 style="color:var(--accent-red)">‚ò†Ô∏è Option Hardcore</h3><div class="check-item"><span>Activer Risque de Mort</span><input type="checkbox" id="chk-death" onchange="toggleDeathRisk()" style="transform:scale(1.5); accent-color: var(--accent-red);"></div></div>
        
        <div class="box"><h3>1. Mat√©riel disponible</h3><div id="liste-materiel"></div></div>
        
        <div id="settings-info-deck" class="settings-count-display">0 Cartes Actives</div>
        
        <div class="box"><h3>2. Composition du paquet</h3><div id="liste-regles"></div></div>
        <div class="box"><h3>3. Partage & Synchro</h3><button class="btn-action btn-share" onclick="genererQRCode()">üì≤ Afficher mon QR Code</button><div id="qr-display"><img id="qr-image" src="" alt="QR Code" /></div><button class="btn-action btn-scan" onclick="demarrerScanner()">üì∑ Scanner une config</button><div id="reader"></div><p id="scan-result" style="text-align:center; color:#4caf50; font-weight:bold; margin-top:10px;"></p></div>
        <div style="height: 80px;"></div>
        <div class="settings-footer"><button class="footer-btn btn-cancel" onclick="annulerReglages()">ANNULER</button><button class="footer-btn btn-save" onclick="sauvegarderEtQuitter()">VALIDER</button></div>
    </div>

    <div id="myModal" class="modal" onclick="fermerModal()"><div class="modal-content" onclick="event.stopPropagation()"><h3 id="modal-title" style="color:var(--accent-orange); margin-top:0;">Aper√ßu</h3><div id="modal-body"></div><button onclick="fermerModal()" style="width:100%; padding:15px; margin-top:15px; background:#444; color:white; border:none; border-radius:4px; font-weight:bold;">FERMER</button></div></div>

    <script>
        /* --- AUDIO --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let beepInterval = null; let flatlineOsc = null;
        function initAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playBeep() { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.value = 900; gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15); osc.start(); osc.stop(audioCtx.currentTime + 0.15); }
        function playFlatline() { if(flatlineOsc) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.value = 800; gain.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.start(); flatlineOsc = osc; }
        function stopAllAudio() { if(beepInterval) { clearInterval(beepInterval); beepInterval = null; } if(flatlineOsc) { try { flatlineOsc.stop(); } catch(e){} flatlineOsc = null; } }

        /* --- DATA MISE A JOUR V20 --- */
        const DB_MATERIEL_BASE = ["Garrot", "Bandage", "Poche de transfusion", "Attelle", "Morphine", "√âpin√©phrine", "Pansement 3 c√¥t√©s"];
        const MEMBRES = ["Bras Gauche", "Bras Droit", "Jambe Gauche", "Jambe Droite"];
        
        const DB_REGLES = {
            classique: [
                { id: "c1", titre: "DCD", zone: "T√™te ou Torse", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "c2", titre: "Inconscient", zone: "Torse", gravite: "Critique", effet: "30s massage + Poche", matos: ["Poche de transfusion"] },
                { id: "c3", titre: "H√©morragie", typeZone: "membre", gravite: "Critique", effet: "Garrot + Poche", matos: ["Garrot", "Bandage", "Poche de transfusion"] },
                { id: "c4", titre: "Saignement", typeZone: "membre", gravite: "Grave", effet: "Bandage + Poche", matos: ["Bandage", "Poche de transfusion"] },
                { id: "c5", titre: "Fracture", typeZone: "membre", gravite: "Grave", effet: "Attelle", matos: ["Bandage", "Attelle"] },
                { id: "c6", titre: "√âraflure", typeZone: "membre", gravite: "L√©g√®re", effet: "Bandage", matos: ["Bandage"] },
                { id: "a12", titre: "Choc Casque", zone: "T√™te", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] },
                { id: "a13", titre: "Choc Gilet", zone: "Torse", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] }
            ],
            avance: [
                { id: "a1", titre: "DCD", zone: "T√™te", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "a2", titre: "DCD", zone: "Torse", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "a3", titre: "Inconscient", zone: "Torse", gravite: "Critique", effet: "Bandage + Massage + √âpi + Poche", matos: ["Bandage", "√âpin√©phrine", "Poche de transfusion"] },
                { id: "a4", titre: "Plaie soufflante", zone: "Torse", gravite: "Critique", effet: "Pnsmt 3 c√¥t√©s + Morphine + Poche", matos: ["Pansement 3 c√¥t√©s", "Morphine", "Poche de transfusion"] },
                { id: "a5", titre: "H√©morragie", typeZone: "membre", gravite: "Critique", effet: "Garrot + Bandage + Morphine + Poche", matos: ["Garrot", "Bandage", "Morphine", "Poche de transfusion"] },
                { id: "a6", titre: "Saignement grave", typeZone: "membre", gravite: "Grave", effet: "Bandage + Morphine", matos: ["Bandage", "Morphine"] },
                { id: "a7", titre: "Saignement", typeZone: "membre", gravite: "Grave", effet: "Bandage", matos: ["Bandage"] },
                { id: "a8", titre: "Fracture", typeZone: "membre", gravite: "Grave", effet: "Bandage + Attelle + Morphine", matos: ["Bandage", "Attelle", "Morphine"] },
                { id: "a9", titre: "√âraflure", typeZone: "membre", gravite: "L√©g√®re", effet: "Bandage", matos: ["Bandage"] },
                { id: "a10", titre: "Prot. Balistique", zone: "T√™te", gravite: "Sp√©cial", effet: "Si Prot: Rien. Sinon: √âraflure (Bandage)", matos: [] },
                { id: "a11", titre: "Prot. Balistique", zone: "Torse", gravite: "Sp√©cial", effet: "Si Prot: H√©matome (Morphine). Sinon: Bandage", matos: ["Morphine", "Bandage"] },
                { id: "a12", titre: "Choc Casque", zone: "T√™te", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] },
                { id: "a13", titre: "Choc Gilet", zone: "Torse", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] }
            ],
            explosion: [
                { id: "e1", titre: "DCD (Blast)", zone: "T√™te", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "e2", titre: "DCD (Blast)", zone: "Torse", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "e3", titre: "Inconscient", zone: "Torse", gravite: "Critique", effet: "Bandage + 30s Massage + √âpi + Poche", matos: ["Bandage", "√âpin√©phrine", "Poche de transfusion"] },
                { id: "e4", titre: "Plaie Soufflante", zone: "Torse", gravite: "Critique", effet: "Pnsmt 3 c√¥t√©s + Morphine + Poche", matos: ["Pansement 3 c√¥t√©s", "Morphine", "Poche de transfusion"] },
                { id: "e5", titre: "H√©morragie Massive", typeZone: "membre", gravite: "Critique", effet: "Garrot + Bandage + Morphine + Poche", matos: ["Garrot", "Bandage", "Morphine", "Poche de transfusion"] },
                { id: "e6", titre: "Saignement Grave", typeZone: "membre", gravite: "Grave", effet: "Bandage + Morphine", matos: ["Bandage", "Morphine"] },
                { id: "e7", titre: "Saignement", typeZone: "membre", gravite: "Grave", effet: "Bandage", matos: ["Bandage"] },
                { id: "e8", titre: "Fracture Ouverte", typeZone: "membre", gravite: "Grave", effet: "Bandage + Attelle + Morphine", matos: ["Bandage", "Attelle", "Morphine"] },
                { id: "e9", titre: "√âraflure (√âclat)", typeZone: "membre", gravite: "L√©g√®re", effet: "Bandage", matos: ["Bandage"] },
                { id: "e10", titre: "Prot. Balistique", zone: "T√™te", gravite: "Sp√©cial", effet: "Prot√©g√©: Rien. Sinon: √âraflure", matos: [] },
                { id: "e11", titre: "Prot. Balistique", zone: "Torse", gravite: "Sp√©cial", effet: "Prot√©g√©: H√©matome. Sinon: Bandage", matos: ["Morphine", "Bandage"] },
                { id: "e12", titre: "Souffle (Casque)", zone: "T√™te", gravite: "Sp√©cial", effet: "Prot√©g√©: Sonn√©. Sinon: DCD", matos: [] },
                { id: "e13", titre: "Souffle (Gilet)", zone: "Torse", gravite: "Sp√©cial", effet: "Prot√©g√©: Sonn√©. Sinon: DCD", matos: [] }
            ]
        };

        let appState = { mode: "classique", deathRisk: false, explosionEnabled: false, materiel: {}, quantites: {}, customDecks: [] };
        let timerLogic = null; let isTimerActive = false;
        let currentDeckId = null; let currentCardIndex = null;
        let tempMatosSelection = [];

        window.onload = function() { chargerSauvegarde(); updateUI_Game(); };

        /* --- BUILDER LOGIC --- */
        function ouvrirBuilder() { showScreen('screen-builder'); renderCustomDecksList(); }
        function creerNouveauPaquet() { currentDeckId = Date.now().toString(); appState.customDecks.push({ id: currentDeckId, name: "Nouveau Paquet", showOnHome: true, cards: [], customMaterials: [] }); editDeck(currentDeckId); }
        function editDeck(id) { currentDeckId = id; const deck = appState.customDecks.find(d => d.id === id); document.getElementById('deck-name').value = deck.name; document.getElementById('deck-show-home').checked = deck.showOnHome; renderDeckCardsList(deck); showScreen('screen-deck-edit'); }
        function renderCustomDecksList() { const list = document.getElementById('custom-decks-list'); list.innerHTML = ""; appState.customDecks.forEach(deck => { let div = document.createElement('div'); div.className = "builder-item"; div.innerHTML = `<div><strong>${deck.name}</strong><br><span style="font-size:0.8em; color:#888;">${deck.cards.length} cartes</span></div><button class="btn-mini btn-view" onclick="editDeck('${deck.id}')">‚úèÔ∏è</button>`; list.appendChild(div); }); }
        function renderDeckCardsList(deck) { const list = document.getElementById('deck-cards-list'); list.innerHTML = ""; deck.cards.forEach((card, index) => { let div = document.createElement('div'); div.className = "card-preview-mini"; div.style.borderLeftColor = getColor(card.gravite); div.innerHTML = `<div style="flex-grow:1; margin-right:10px;"><strong style="color:${getColor(card.gravite)}">${card.titre}</strong><div style="font-size:0.8em; color:#ccc;">${card.zone}</div></div><div style="min-width:70px; text-align:right;"><button class="btn-mini" onclick="editCard(${index})">‚úèÔ∏è</button><button class="btn-mini" style="background:#d32f2f; margin-left:5px;" onclick="deleteCard(${index})">X</button></div>`; list.appendChild(div); }); }
        function sauvegarderPaquetCourant() { const deck = appState.customDecks.find(d => d.id === currentDeckId); deck.name = document.getElementById('deck-name').value || "Paquet Sans Nom"; deck.showOnHome = document.getElementById('deck-show-home').checked; sauvegarderEtQuitterBuilder(); }
        function supprimerPaquetCourant() { if(confirm("Supprimer ce paquet d√©finitivement ?")) { appState.customDecks = appState.customDecks.filter(d => d.id !== currentDeckId); sauvegarderEtQuitterBuilder(); } }
        function sauvegarderEtQuitterBuilder() { localStorage.setItem('airsoftMedicConfig', JSON.stringify(appState)); updateUI_Game(); ouvrirBuilder(); }

        // --- CARD EDITING ---
        function ajouterCarteCustom() {
            currentCardIndex = -1; 
            document.getElementById('card-gravity').value = "L√©g√®re"; document.getElementById('card-title').value = ""; document.getElementById('card-zone').value = ""; document.getElementById('card-effect').value = "";
            tempMatosSelection = [];
            renderMatosEditor();
            showScreen('screen-card-edit');
        }
        function editCard(index) {
            currentCardIndex = index;
            const deck = appState.customDecks.find(d => d.id === currentDeckId);
            const card = deck.cards[index];
            document.getElementById('card-gravity').value = card.gravite; document.getElementById('card-title').value = card.titre; document.getElementById('card-zone').value = card.zone; document.getElementById('card-effect').value = card.effet;
            tempMatosSelection = [...card.matos];
            renderMatosEditor();
            showScreen('screen-card-edit');
        }
        function renderMatosEditor() {
            const list = document.getElementById('card-matos-list'); list.innerHTML = "";
            const deck = appState.customDecks.find(d => d.id === currentDeckId);
            const allMatos = [...new Set([...DB_MATERIEL_BASE, ...(deck.customMaterials || [])])];
            allMatos.forEach(m => {
                const checked = tempMatosSelection.includes(m) ? 'checked' : '';
                let div = document.createElement('div'); div.className = "matos-check";
                div.innerHTML = `<input type="checkbox" onchange="toggleTempMatos('${m}')" ${checked}> ${m}`;
                list.appendChild(div);
            });
        }
        function toggleTempMatos(m) { if(tempMatosSelection.includes(m)) tempMatosSelection = tempMatosSelection.filter(x => x !== m); else tempMatosSelection.push(m); }
        function addNewMatosToEditor() {
            const name = document.getElementById('new-matos-name').value.trim();
            if(!name) return;
            const deck = appState.customDecks.find(d => d.id === currentDeckId);
            if(!deck.customMaterials) deck.customMaterials = [];
            if(!deck.customMaterials.includes(name) && !DB_MATERIEL_BASE.includes(name)) { deck.customMaterials.push(name); }
            if(!tempMatosSelection.includes(name)) tempMatosSelection.push(name);
            document.getElementById('new-matos-name').value = "";
            renderMatosEditor();
        }
        function validerCarte() {
            const card = {
                titre: document.getElementById('card-title').value || "Blessure",
                zone: document.getElementById('card-zone').value || "Corps",
                gravite: document.getElementById('card-gravity').value,
                effet: document.getElementById('card-effect').value || "Aucun soin",
                matos: tempMatosSelection,
                typeZone: "custom", finalZone: document.getElementById('card-zone').value || "Corps"
            };
            const deck = appState.customDecks.find(d => d.id === currentDeckId);
            if(currentCardIndex === -1) deck.cards.push(card); else deck.cards[currentCardIndex] = card;
            editDeck(currentDeckId);
        }
        function deleteCard(index) { const deck = appState.customDecks.find(d => d.id === currentDeckId); deck.cards.splice(index, 1); editDeck(currentDeckId); }
        function annulerEditionCarte() { editDeck(currentDeckId); }

        /* --- LOGIQUE JEU & REGLAGES --- */
        function ouvrirReglages() {
            const select = document.getElementById('select-mode');
            select.innerHTML = `<option value="classique">CLASSIQUE</option><option value="avance">AVANC√â</option>`;
            appState.customDecks.forEach(d => {
                let opt = document.createElement('option'); opt.value = d.id; opt.innerText = d.name.toUpperCase() + " (Custom)";
                select.appendChild(opt);
            });
            select.value = appState.mode;
            document.getElementById('chk-death').checked = appState.deathRisk || false; 
            document.getElementById('chk-explosion').checked = appState.explosionEnabled || false; 
            renderSettingsMenu(appState.mode);
            showScreen('screen-settings'); document.getElementById('qr-display').style.display="none"; document.getElementById('reader').style.display="none";
        }

        function calculateTotalActive(mode) {
            let total = 0;
            let rules = [];
            if (DB_REGLES[mode]) rules = DB_REGLES[mode];
            else {
                 const deck = appState.customDecks.find(d => d.id === mode);
                 if(deck) rules = deck.cards;
            }
            if(!rules) return 0;
            
            rules.forEach((r, idx) => {
                 let rId = r.id || (mode + "_c_" + idx);
                 if (appState.quantites[rId] === undefined) appState.quantites[rId] = 2; // Default qty logic check
                 // Check if active
                 if(r.matos.every(m => appState.materiel[m])) {
                     total += appState.quantites[rId] * (r.typeZone === 'membre' ? 4 : 1);
                 }
            });
            return total;
        }

        function renderSettingsMenu(mode) {
            const boxExplo = document.getElementById('box-explosion-opt');
            boxExplo.style.display = (mode === 'avance') ? 'block' : 'none';
            
            // 0. Identifier le mat√©riel UTILE pour ce mode
            let usefulMaterials = new Set();
            let rulesForAnalysis = [];
            if (DB_REGLES[mode]) rulesForAnalysis = DB_REGLES[mode];
            else {
                const d = appState.customDecks.find(d => d.id === mode);
                if(d) rulesForAnalysis = d.cards;
            }
            if(mode === 'avance' && appState.explosionEnabled) {
                rulesForAnalysis = rulesForAnalysis.concat(DB_REGLES.explosion);
            }
            rulesForAnalysis.forEach(r => {
                if(r.matos) r.matos.forEach(m => usefulMaterials.add(m));
            });

            // 1. Liste Mat√©riel
            const mc = document.getElementById('liste-materiel'); mc.innerHTML = "";
            let matosList = [...DB_MATERIEL_BASE];
            let deck = appState.customDecks.find(d => d.id === mode);
            if(deck && deck.customMaterials) matosList = [...matosList, ...deck.customMaterials];
            else if (mode === 'avance') { if(!matosList.includes("Morphine")) matosList.push("Morphine", "√âpin√©phrine", "Pansement 3 c√¥t√©s"); }

            matosList.forEach(item => {
                if (appState.materiel[item] === undefined) appState.materiel[item] = true;
                
                // Check if useful
                let isUseful = usefulMaterials.has(item);
                
                let div = document.createElement('div'); 
                div.className = "check-item" + (isUseful ? "" : " disabled");
                
                div.innerHTML = `
                    <span style="${isUseful ? '' : 'text-decoration:line-through;'}">${item}</span>
                    <input type="checkbox" onchange="toggleMatos('${item}')" ${appState.materiel[item]?'checked':''} style="transform:scale(1.2)" ${isUseful ? '' : 'disabled'}>
                `; 
                mc.appendChild(div);
            });

            // UPDATE COMPTEUR SETTINGS
            let totalActive = calculateTotalActive(mode);
            
            // 2. Liste R√®gles
            const rc = document.getElementById('liste-regles'); rc.innerHTML = "";
            let reglesAffichees = [];
            
            if(DB_REGLES[mode]) reglesAffichees = [...DB_REGLES[mode]];
            else if (deck) reglesAffichees = [...deck.cards];

            if (mode === 'avance' && appState.explosionEnabled) {
                reglesAffichees.push({ sep: true, label: "--- CARTES EXPLOSION ---" });
                reglesAffichees = reglesAffichees.concat(DB_REGLES.explosion);
            }

            let realTotalCount = 0;

            reglesAffichees.forEach((r, idx) => {
                if(r.sep) { let div = document.createElement('div'); div.style.color = "var(--accent-orange)"; div.style.fontWeight="bold"; div.style.textAlign="center"; div.style.marginTop="15px"; div.style.marginBottom="5px"; div.innerText = r.label; rc.appendChild(div); return; }
                
                let rId = r.id || (mode + "_c_" + idx); 
                if(!r.id) r.id = rId;

                if (appState.quantites[rId] === undefined) appState.quantites[rId] = 2;
                
                let matosManquant = r.matos.find(m => appState.materiel[m] === false);
                let estActif = matosManquant === undefined;

                if(estActif) {
                    realTotalCount += appState.quantites[rId] * (r.typeZone === 'membre' ? 4 : 1);
                }

                let div = document.createElement('div'); div.className = "check-item"; div.style.opacity = estActif ? "1" : "0.5";
                let prefix = (r.id && r.id.startsWith('e')) ? "üí• " : "";
                
                div.innerHTML = `<div style="flex-grow:1"><strong style="color:${getColor(r.gravite)}">${prefix}${r.titre}</strong><div style="font-size:0.7em; color:#888;">${r.zone||"Custom"}</div></div><div class="qty-control"><button class="btn-mini btn-view" onclick="voirDetails('${r.id}', '${mode}')">üëÅÔ∏è</button><button class="btn-mini" onclick="modifQty('${r.id}', -1, '${mode}')">‚ûñ</button><span style="width:20px; text-align:center;">${appState.quantites[r.id]}</span><button class="btn-mini" onclick="modifQty('${r.id}', 1, '${mode}')">‚ûï</button></div>`;
                rc.appendChild(div);
            });

            document.getElementById('settings-info-deck').innerText = realTotalCount + " Cartes Actives dans le paquet";
        }
        
        /* --- ENGINE CORE --- */
        function preparerTirage(sourceId) {
            let deck = [];
            let sourceRegles = [];

            if (sourceId === 'explosion') sourceRegles = DB_REGLES.explosion;
            else if (sourceId === 'bille') {
                if(DB_REGLES[appState.mode]) sourceRegles = DB_REGLES[appState.mode];
                else {
                    const cDeck = appState.customDecks.find(d => d.id === appState.mode);
                    if(cDeck) sourceRegles = cDeck.cards;
                }
            } else {
                const cDeck = appState.customDecks.find(d => d.id === sourceId);
                if(cDeck) sourceRegles = cDeck.cards;
            }

            sourceRegles.forEach((r, idx) => {
                if (!r.matos.every(m => appState.materiel[m])) return;
                let rId = r.id || (appState.mode + "_c_" + idx); 
                let qty = appState.quantites[rId] !== undefined ? appState.quantites[rId] : 0;
                if (qty <= 0) return;
                
                if (r.typeZone === "membre") MEMBRES.forEach(m => deck.push({ ...r, finalZone: m }));
                else deck.push({ ...r, finalZone: r.zone || r.finalZone });
            });

            if (deck.length === 0) { alert("Paquet vide ou mat√©riel manquant !"); return null; }
            return deck[Math.floor(Math.random() * deck.length)];
        }

        /* --- STANDARD FUNCTIONS --- */
        function lancerSequenceTirage(sourceId) { initAudio(); const carte = preparerTirage(sourceId); if(!carte) return; showScreen('screen-march'); const screenMarch = document.getElementById('screen-march'); screenMarch.innerHTML = screenMarch.innerHTML; setTimeout(() => { afficherResultat(carte); }, 5000); }
        function afficherResultat(c) { showScreen('screen-result'); clearInterval(timerLogic); stopAllAudio(); isTimerActive = false; document.getElementById('danger-zone-container').style.display = "none"; document.getElementById('death-overlay').style.display = "none"; const btn = document.getElementById('btn-card'); btn.innerText = "Nouveau Diagnostic"; btn.style.background = ""; const col = getColor(c.gravite); const card = document.getElementById('ui-card'); const badge = document.getElementById('badge-gravite'); if(c.gravite === "D√âC√àS") { card.style.borderColor = "#ffffff"; card.style.boxShadow = `0 0 10px #ffffff`; badge.style.backgroundColor = "#000"; badge.style.border = "1px solid white"; btn.style.backgroundColor = "#333"; } else { card.style.borderColor = col; card.style.boxShadow = `0 0 40px ${col}60`; badge.style.backgroundColor = col; badge.style.border = "none"; btn.style.backgroundColor = col; } document.getElementById('txt-gravite').innerText = c.gravite; document.getElementById('txt-zone').innerText = c.finalZone || c.zone; document.getElementById('txt-titre').innerText = c.titre; document.getElementById('txt-soins').innerText = c.effet; if(appState.deathRisk && c.gravite === "Critique" && c.gravite !== "D√âC√àS") { if(Math.random() < 0.40) { activerTimerMort(); } } }
        
        function updateUI_Game() { 
            let modeLabel = "";
            if(appState.mode === 'classique') modeLabel = "Mode CLASSIQUE";
            else if(appState.mode === 'avance') modeLabel = "Mode AVANC√â";
            else {
                const d = appState.customDecks.find(d=>d.id===appState.mode);
                modeLabel = d ? d.name + " (Custom)" : "Mode Inconnu";
            }
            document.getElementById('top-indicator').innerText = modeLabel;
            
            const blastBtn = document.getElementById('explosion-trigger-container'); 
            if(appState.mode === 'avance' && appState.explosionEnabled) blastBtn.style.display = "flex"; else blastBtn.style.display = "none"; 
            
            const container = document.getElementById('dynamic-buttons-container'); 
            const oldBtns = document.querySelectorAll('.js-custom-btn'); oldBtns.forEach(b => b.remove()); 
            if(appState.customDecks) { appState.customDecks.forEach(deck => { if(deck.showOnHome) { const div = document.createElement('div'); div.className = "btn-circle-container btn-container-shared js-custom-btn"; div.innerHTML = `<div class="pulse-ring-custom"></div><button class="main-btn btn-core-shared custom-btn-style" onclick="lancerSequenceTirage('${deck.id}')"><img src="btn-custom.png" class="icon-custom" onerror="this.src='picto-blesse.png'" alt="Custom"></button><div class="btn-label">${deck.name}</div>`; container.appendChild(div); } }); } 
            
            // Calculer total pour l'accueil
            let total = calculateTotalActive(appState.mode);
            if(appState.mode === 'avance' && appState.explosionEnabled) {
                // Ajout manuel explosion
                DB_REGLES.explosion.forEach((r, idx) => {
                     let rId = r.id; // Explosion cards have static IDs
                     if (appState.quantites[rId] === undefined) appState.quantites[rId] = 2;
                     if(r.matos.every(m => appState.materiel[m])) total += appState.quantites[rId] * (r.typeZone === 'membre' ? 4 : 1);
                });
            }
            document.getElementById('info-deck').innerText = total + " cartes actives"; 
        }

        function voirDetails(id, mode) { let regle = null; if(DB_REGLES[mode]) regle = DB_REGLES[mode].find(r => r.id === id); else { const deck = appState.customDecks.find(d => d.id === mode); if(deck) regle = deck.cards.find(r => r.id === id); } if(!regle && DB_REGLES.explosion) regle = DB_REGLES.explosion.find(r => r.id === id); if(!regle) return; const modalBody = document.getElementById('modal-body'); document.getElementById('modal-title').innerText = regle.titre; modalBody.innerHTML = ""; const items = (regle.typeZone === "membre") ? MEMBRES : [regle.zone]; items.forEach(z => { modalBody.innerHTML += `<div class="preview-card" style="border-left-color:${getColor(regle.gravite)}"><h4 style="color:${getColor(regle.gravite) === "#111" ? "#fff" : getColor(regle.gravite)}">${regle.gravite}</h4><p><strong>Zone:</strong> ${z}</p><p><strong>Soins:</strong> ${regle.effet}</p><p style="font-size:0.8em; color:#aaa; margin-top:5px;">Matos: ${regle.matos.join(', ')}</p></div>`; }); document.getElementById('myModal').style.display = "block"; }
        
        function showScreen(id) { document.querySelectorAll('.screen, .flex-center').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function activerTimerMort() { isTimerActive = true; document.getElementById('danger-zone-container').style.display = "block"; const btn = document.getElementById('btn-card'); btn.innerText = "SOINS EFFECTU√âS (SAUVER)"; btn.style.backgroundColor = "#d32f2f"; beepInterval = setInterval(playBeep, 1000); let duree = 30 + Math.random() * 30; let tempsRestant = duree; timerLogic = setInterval(() => { tempsRestant -= 0.1; if(tempsRestant <= 0) { clearInterval(timerLogic); mortDuPatient(); } }, 100); }
        function mortDuPatient() { isTimerActive = false; stopAllAudio(); playFlatline(); document.getElementById('death-overlay').style.display = "flex"; }
        function actionPrincipale() { if(isTimerActive) { clearInterval(timerLogic); stopAllAudio(); isTimerActive = false; alert("PATIENT STABILIS√â !"); retourAccueil(); } else { stopAllAudio(); retourAccueil(); } }
        function retourAccueil() { clearInterval(timerLogic); stopAllAudio(); showScreen('screen-game'); }
        function toggleDeathRisk() { appState.deathRisk = document.getElementById('chk-death').checked; }
        function toggleExplosion() { appState.explosionEnabled = document.getElementById('chk-explosion').checked; updateUI_Game(); }
        function annulerReglages() { showScreen('screen-game'); if(html5QrcodeScanner) html5QrcodeScanner.stop(); }
        function sauvegarderEtQuitter() { localStorage.setItem('airsoftMedicConfig', JSON.stringify(appState)); updateUI_Game(); annulerReglages(); }
        function chargerSauvegarde() { const save = localStorage.getItem('airsoftMedicConfig'); if (save) appState = JSON.parse(save); else { appState = { mode: "classique", deathRisk: false, explosionEnabled: false, materiel: {}, quantites: {}, customDecks: [] }; initDefaults("classique"); initDefaults("avance"); initDefaults("explosion"); } if(!appState.customDecks) appState.customDecks = []; }
        function initDefaults(m) { if(m === "explosion" && !DB_REGLES.explosion) return; if(m !== "explosion" && DB_MATERIEL_BASE) DB_MATERIEL_BASE.forEach(i => appState.materiel[i] = true); DB_REGLES[m].forEach(r => appState.quantites[r.id] = (r.gravite==="L√©g√®re"?5:(r.gravite==="D√âC√àS"?1:2))); }
        function changerModeMenu(v) { appState.mode = v; renderSettingsMenu(v); }
        function toggleMatos(i) { appState.materiel[i] = !appState.materiel[i]; renderSettingsMenu(appState.mode); }
        function modifQty(id, d, mode) { appState.quantites[id] += d; if(appState.quantites[id]<0) appState.quantites[id]=0; renderSettingsMenu(mode); }
        function getColor(g) { if(g==="Critique") return "#d32f2f"; if(g==="Grave") return "#f57c00"; if(g==="L√©g√®re") return "#388e3c"; if(g==="D√âC√àS") return "#111"; return "#7b1fa2"; }
        function fermerModal() { document.getElementById('myModal').style.display = "none"; }
        function genererQRCode() { const json = JSON.stringify(appState); const url = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${btoa(json)}`; document.getElementById('qr-image').src = url; document.getElementById('qr-display').style.display = "block"; document.getElementById('reader').style.display = "none"; }
        let html5QrcodeScanner;
        function demarrerScanner() { document.getElementById('qr-display').style.display = "none"; document.getElementById('reader').style.display = "block"; document.getElementById('scan-result').innerText = "Veuillez scanner..."; html5QrcodeScanner = new Html5Qrcode("reader"); html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => { html5QrcodeScanner.stop(); try { const conf = JSON.parse(atob(decodedText)); appState = conf; sauvegarderEtQuitter(); alert("Configuration charg√©e avec succ√®s !"); } catch(e) { alert("Code invalide"); } }); }
        function updateCardColorPreview() { /* Helper optionnel */ }
    </script>
</body>
</html>

