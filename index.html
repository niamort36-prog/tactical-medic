<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tactical Medic V32 - Smart Inventory</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <style>
        /* --- CHARTE GRAPHIQUE --- */
        :root { 
            --bg-dark: #121212; 
            --text-main: #f0f0f0;
            --accent-red: #d32f2f; 
            --accent-orange: #f57c00; 
            --accent-green: #388e3c;
            --accent-blue: #1976d2;
            --card-bg: #1c1c1c;
            --font-stack: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body { 
            font-family: var(--font-stack); background-color: var(--bg-dark); color: var(--text-main);
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
            user-select: none;
        }

        .topo-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background-image: url('fond-topo.png'); background-size: cover; opacity: 0.2;
        }

        /* --- HEADER --- */
        header {
            padding: 10px 15px; 
            display: grid; 
            grid-template-columns: 50px 1fr auto; 
            align-items: center;
            z-index: 10; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
            border-bottom: 4px solid #333; transition: border-color 0.3s;
        }
        .app-title { font-size: 0.9em; font-weight: 800; text-transform: uppercase; text-align: center; white-space: nowrap; }
        .mode-subtitle { font-size: 0.7em; color: #888; display: block; text-align: center; font-weight: bold; text-transform: uppercase; }
        .header-actions { display: flex; flex-direction: row; gap: 8px; justify-content: flex-end; }
        .header-btn {
            background: rgba(40,40,40,0.9); border: 1px solid #555; color: white; border-radius: 8px; 
            width: 38px; height: 38px; font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .header-btn.multi { border-color: var(--accent-blue); color: var(--accent-blue); }
        .header-btn.online { background: var(--accent-blue); box-shadow: 0 0 10px var(--accent-blue); animation: pulseSlow 2s infinite; }
        @keyframes pulseSlow { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- SCREENS --- */
        .screen { display: none; padding: 20px; flex-grow: 1; overflow-y: auto; padding-bottom: 100px; z-index: 5; }
        .screen.active { display: block; }
        .flex-center { display: none; flex-direction: column; align-items: center; justify-content: center; height: 85%; text-align: center; z-index: 5; position: relative; }
        .flex-center.active { display: flex; }

        /* --- BUTTONS --- */
        .buttons-wrapper { display: flex; flex-direction: column; align-items: center; gap: 15px; width: 100%; max-height: 65vh; overflow-y: auto; padding: 40px 20px; box-sizing: border-box; }
        .btn-container-shared { position: relative; width: 180px; height: 180px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; margin: 10px 0; }
        .btn-core-shared { width: 150px; height: 150px; border-radius: 50%; background: rgba(20, 20, 20, 0.8); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); z-index: 2; overflow: hidden; transition: transform 0.1s; }
        .btn-core-shared:active { transform: scale(0.95); }
        .pulse-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--accent-red); box-shadow: 0 0 40px rgba(211, 47, 47, 0.6); animation: pulse 2.5s infinite; }
        .pulse-ring-blast { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--accent-orange); box-shadow: 0 0 40px rgba(245, 124, 0, 0.6); animation: pulse 3s infinite; }
        .pulse-ring-custom { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--accent-green); box-shadow: 0 0 40px rgba(56, 142, 60, 0.6); animation: pulse 3s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); opacity: 0.8; } 100% { transform: scale(1.1); opacity: 0; } }
        .btn-label { position: absolute; bottom: 25px; width: 100%; text-align: center; font-size: 0.8em; font-weight: 800; color: white; pointer-events: none; text-transform: uppercase; text-shadow: 0 2px 4px black; }

        .icon-wounded { width: 70%; height: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(211,47,47,0.8)); }
        .icon-blast { width: 65%; height: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(245, 124, 0, 0.8)); }
        .icon-custom { width: 60%; height: auto; object-fit: contain; filter: drop-shadow(0 0 8px rgba(56, 142, 60, 0.8)); }

        /* --- MARCH --- */
        .march-list { list-style: none; padding: 0; text-align: left; font-size: 2.2em; font-weight: 900; color: var(--accent-orange); text-shadow: 0 0 15px rgba(245, 124, 0, 0.5); }
        .march-list li { margin-bottom: 15px; opacity: 0; animation: fadeIn 0.4s forwards; }
        .march-list li:nth-child(1) { animation-delay: 0.2s; } .march-list li:nth-child(2) { animation-delay: 1.0s; } .march-list li:nth-child(3) { animation-delay: 1.8s; } .march-list li:nth-child(4) { animation-delay: 2.6s; } .march-list li:nth-child(5) { animation-delay: 3.4s; }
        @keyframes fadeIn { to { opacity: 1; transform: translateX(10px); } }

        /* --- RESULT --- */
        .result-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); }
        .tac-card { background: var(--card-bg); width: 85%; max-width: 380px; border-radius: 12px; padding: 25px; border: 3px solid #333; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.5); text-align: left; }
        .card-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.85em; text-transform: uppercase; color: white; margin-bottom: 15px; }
        .card-title { font-size: 1.5em; font-weight: 800; color: white; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; line-height: 1.2; }
        .card-label { font-size: 0.75em; color: #777; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; margin-top: 20px; display: block; }
        .card-desc { font-size: 1.3em; color: #ddd; font-weight: 500; }
        .card-box { border: 1px solid #444; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; color: #fff; font-size: 1em; line-height: 1.5; }
        .btn-card-action { margin-top: 30px; width: 100%; padding: 16px; border-radius: 8px; border: none; font-weight: bold; font-size: 1em; cursor: pointer; text-transform: uppercase; color: white; }

        /* --- DEATH --- */
        #death-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.98); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 20; text-align: center; }
        .skull-icon { font-size: 5em; margin-bottom: 20px; text-shadow: 0 0 20px red; }
        .death-text { color: #d32f2f; font-size: 2.2em; font-weight: 900; text-transform: uppercase; letter-spacing: 2px; animation: blinkFast 2s infinite; }
        #danger-zone-container { display: none; margin-top: 20px; background: rgba(85, 0, 0, 0.3); border: 1px solid #d32f2f; border-radius: 8px; padding: 15px; text-align: center; }
        .invisible-timer-warning { color: #ff3333; font-weight: 900; font-size: 1em; text-transform: uppercase; animation: blinkFast 0.8s infinite; }
        @keyframes blinkFast { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* --- UI ELEMENTS --- */
        .box { background: rgba(30, 30, 30, 0.95); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #333; }
        h3 { margin-top: 0; color: var(--accent-orange); font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 8px; letter-spacing: 1px;}
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        .btn-mini { width: 32px; height: 32px; border-radius: 4px; border: none; font-weight: bold; background: #444; color: white; cursor:pointer;}
        .form-input { width: 100%; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; font-size: 1em; margin-bottom:10px; }
        .btn-action { width: 100%; padding: 15px; margin-top: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; text-transform: uppercase;}
        .btn-create { border: 1px solid var(--accent-green); background: rgba(56, 142, 60, 0.2); }
        .btn-join { border: 1px solid var(--accent-blue); background: rgba(25, 118, 210, 0.2); }
        .preview-card-mini { padding:10px; border:1px solid #444; background:#111; border-radius:4px; margin-bottom:5px; border-left-width:4px; }
        .settings-footer { position: fixed; bottom: 0; left: 0; width: 100%; display: flex; z-index: 20; border-top: 1px solid #333; background: #121212;}
        .footer-btn { flex: 1; padding: 20px; border: none; font-weight: bold; font-size: 1em; cursor: pointer; text-transform: uppercase; background:#1a1a1a; color:#888; }
        .footer-btn.save { background: var(--accent-green); color: white; }
        .separator { color: var(--accent-orange); font-weight: bold; text-align: center; margin: 15px 0 5px 0; padding-top: 10px; border-top: 1px dashed #444; letter-spacing: 1px; font-size: 0.9em; }

        /* --- HOST DASHBOARD --- */
        .player-row { background: #222; border: 1px solid #444; padding: 10px; margin-bottom: 8px; border-radius: 6px; display: flex; flex-direction: column; gap: 8px; }
        .player-actions { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px;}
        .btn-dash { padding: 5px 10px; font-size: 0.8em; border-radius: 4px; border: none; cursor: pointer; white-space: nowrap; color: white;}
        #host-connection-id { font-family: monospace; font-size: 1.5em; color: var(--accent-blue); background: black; padding: 10px; border-radius: 4px; border: 1px dashed #444; text-align: center; margin-bottom: 10px;}

        /* --- MODALS --- */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
        .modal-content { background-color: #222; color: #eee; margin: 15% auto; padding: 20px; border-radius: 8px; width: 85%; max-width: 400px; border: 1px solid #444; max-height: 80vh; overflow-y: auto;}

    </style>
</head>
<body>

    <div class="topo-bg"></div>

    <header id="main-header">
        <div style="display:flex;">
            <button id="btn-multi-icon" class="header-btn multi" onclick="ouvrirMenuMultijoueur()">üë•</button>
        </div>
        <div class="app-title-container">
            <div class="app-title">Tactical Medic</div>
            <span id="top-indicator" class="mode-subtitle">Solo</span>
        </div>
        <div class="header-actions">
            <button class="header-btn" onclick="ouvrirBuilder()">‚úèÔ∏è</button>
            <button class="header-btn" onclick="ouvrirReglages()">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="screen-game" class="flex-center active">
        <div id="dynamic-buttons-container" class="buttons-wrapper"></div>
        <div class="text-diagnostic">DIAGNOSTIC</div>
        <div class="text-sub">S√©lectionnez la menace</div>
        <div class="text-count" id="info-deck">Chargement...</div>
    </div>

    <div id="screen-march" class="flex-center">
        <ul class="march-list">
            <li>M - Massive Bleeding</li>
            <li>A - Airways</li>
            <li>R - Respiration</li>
            <li>C - Circulation</li>
            <li>H - Head / Hypothermia</li>
        </ul>
        <div style="margin-top:40px; font-size:0.9em; color:#888; text-transform:uppercase; letter-spacing:2px;">Analyse en cours...</div>
    </div>

    <div id="screen-result" class="screen" style="padding:0; overflow:hidden;">
        <div class="result-wrapper">
            <div id="ui-card" class="tac-card">
                <div id="death-overlay">
                    <div class="skull-icon">üíÄ</div>
                    <div class="death-text">MORT AU COMBAT</div>
                    <div style="color:#aaa; margin-top:10px;">Temps √©coul√© - H√©morragie fatale</div>
                    <button class="btn-card-action" style="background:#555; margin-top:30px;" onclick="retourAccueil()">Fermer le dossier</button>
                </div>
                <div id="badge-gravite" class="card-badge">GRAVE</div>
                <div class="card-title" id="txt-titre">Titre</div>
                <span class="card-label">ZONE</span>
                <div class="card-desc" id="txt-zone">Bras</div>
                <span class="card-label">PROTOCOLE</span>
                <div id="txt-soins" class="card-box">Soins...</div>
                <div id="danger-zone-container">
                    <div class="invisible-timer-warning">‚ö†Ô∏è H√âMORRAGIE ACTIVE<br>URGENCE VITALE</div>
                </div>
                <button id="btn-card" class="btn-card-action" onclick="actionPrincipale()">Nouveau Diagnostic</button>
            </div>
        </div>
    </div>

    <div id="screen-host-dashboard" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:30px; margin-bottom:20px;">
            <h2 style="margin:0;">QG ORGANISATEUR</h2>
            <div style="font-size:0.8em; color:var(--accent-green);">‚óè EN LIGNE</div>
        </div>
        <div class="box" style="text-align:center; border-color:var(--accent-blue);">
            <p style="margin-top:0; color:#aaa; font-size:0.9em;">Code de Partie</p>
            <div id="host-connection-id">...</div>
            <p style="font-size:0.8em; color:#666;">Donnez ce code aux joueurs</p>
        </div>
        <div class="box">
            <h3>JOUEURS (<span id="connected-count">0</span>)</h3>
            <div id="host-player-list"></div>
        </div>
        <button class="btn-action" style="background:#333;" onclick="retourAccueil()">RETOUR JEU</button>
    </div>

    <div id="screen-settings" class="screen">
        <h2 style="margin-top:40px;">R√âGLAGES</h2>
        <div class="box">
            <h3>Mode de Jeu</h3>
            <select id="select-mode" class="form-input" style="width:100%" onchange="changerModeMenu(this.value)"></select>
        </div>
        <div class="box" style="border-color:var(--accent-red)">
            <h3 style="color:var(--accent-red)">‚ò†Ô∏è Option Hardcore</h3>
            <div class="check-item"><span>Activer Risque de Mort</span><input type="checkbox" id="chk-death" onchange="toggleDeathRisk()" style="transform:scale(1.5);"></div>
        </div>
        <div id="box-explosion-opt" class="box" style="display:none; border-color:var(--accent-orange)">
            <h3 style="color:var(--accent-orange)">üí• Explosion</h3>
            <div class="check-item"><span>Activer Cartes Explosion</span><input type="checkbox" id="chk-explosion" onchange="toggleExplosion()" style="transform:scale(1.5);"></div>
        </div>
        <div class="box"><h3>Mat√©riel Requis</h3><div id="liste-materiel"></div></div>
        <div class="box"><h3>Cartes Actives</h3><div id="liste-regles"></div></div>
        <div style="height:50px"></div>
        <div class="settings-footer"><button class="footer-btn" onclick="annulerReglages()">ANNULER</button><button class="footer-btn save" onclick="sauvegarderEtQuitter()">VALIDER</button></div>
    </div>

    <div id="screen-builder" class="screen">
        <h2 style="margin-top:40px;">MES PAQUETS</h2>
        <button class="btn-action btn-create" onclick="creerNouveauPaquet()">+ CR√âER PAQUET</button>
        <div id="custom-decks-list" style="margin-top:20px;"></div>
        <button class="btn-action" style="background:#333;" onclick="retourAccueil()">RETOUR</button>
    </div>

    <div id="screen-deck-edit" class="screen">
        <h2 style="margin-top:40px;">√âDITION</h2>
        <div class="box">
            <input type="text" id="deck-name" class="form-input" placeholder="Nom du paquet">
            <div class="check-item"><span>Afficher sur l'accueil</span><input type="checkbox" id="deck-show-home"></div>
        </div>
        <div class="box">
            <h3>CARTES</h3>
            <button class="btn-mini" onclick="ajouterCarteCustom()" style="width:100%; background:var(--accent-blue); margin-bottom:10px;">+ AJOUTER</button>
            <div id="deck-cards-list"></div>
        </div>
        <button class="btn-action btn-create" onclick="sauvegarderPaquetCourant()">ENREGISTRER</button>
        <button class="btn-action" style="background:#d32f2f;" onclick="supprimerPaquetCourant()">SUPPRIMER</button>
    </div>

    <div id="screen-card-edit" class="screen">
        <h2 style="margin-top:40px;">CARTE</h2>
        <div class="box">
            <select id="card-gravity" class="form-input">
                <option value="D√âC√àS">‚ö´ D√âC√àS</option>
                <option value="Critique">üî¥ CRITIQUE</option>
                <option value="Grave">üü† GRAVE</option>
                <option value="L√©g√®re">üü¢ L√âG√àRE</option>
                <option value="Sp√©cial">üü£ SP√âCIAL</option>
            </select>
            <input type="text" id="card-title" class="form-input" placeholder="Titre (ex: Fracture)">
            <input type="text" id="card-zone" class="form-input" placeholder="Zone (ex: Bras)">
            <textarea id="card-effect" class="form-input" rows="3" placeholder="Effet (ex: Attelle)"></textarea>
            <h3>Mat√©riel Requis</h3>
            <div id="card-matos-list"></div>
            <div style="display:flex; gap:5px; margin-top:10px; border-top:1px solid #333; padding-top:10px;">
                <input type="text" id="new-matos-name" class="form-input" placeholder="Nouveau (ex: D√©fibrillateur)" style="margin:0;">
                <button class="header-btn" onclick="ajouterNouveauMatos()" style="width:40px; background:var(--accent-green);">+</button>
            </div>
        </div>
        <button class="btn-action btn-create" onclick="validerCarte()">VALIDER</button>
        <button class="btn-action" style="background:#333;" onclick="annulerEditionCarte()">ANNULER</button>
    </div>

    <div id="previewModal" class="modal" onclick="document.getElementById('previewModal').style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="preview-title" style="color:var(--accent-orange); margin-top:0;">Aper√ßu</h3>
            <div id="preview-body"></div>
            <button onclick="document.getElementById('previewModal').style.display='none'" class="btn-action" style="background:#333;">FERMER</button>
        </div>
    </div>

    <div id="multiplayerModal" class="modal" style="z-index: 200;">
        <div class="modal-content" style="border: 2px solid var(--accent-blue);">
            <h3 style="color:var(--accent-blue); text-align:center;">MENU MULTIJOUEUR</h3>
            <div class="form-group">
                <label>Votre Pseudo</label>
                <input type="text" id="multi-pseudo" class="form-input" placeholder="Ex: Doc">
            </div>
            <button class="btn-action btn-create" onclick="creerPartieEnLigne()">CR√âER UNE PARTIE (HOST)</button>
            <button class="btn-action btn-join" onclick="document.getElementById('join-input-area').style.display='block'">REJOINDRE UNE PARTIE</button>
            <div id="join-input-area" style="display:none; margin-top:10px;">
                <input type="text" id="join-code" class="form-input" placeholder="Code (ex: MEDIC-1234)" style="text-transform:uppercase;">
                <button class="btn-action btn-join" onclick="rejoindrePartieEnLigne()">CONNEXION</button>
            </div>
            <button onclick="fermerMultiModal()" class="btn-action" style="background:#333;">ANNULER</button>
            <div id="multi-status" style="display:none; text-align:center; padding:10px; color:#aaa;">Connexion...</div>
        </div>
    </div>

    <script>
        /* --- AUDIO --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let beepInterval = null; let flatlineOsc = null;
        function initAudio() { if (audioCtx.state === 'suspended') audioCtx.resume(); }
        function playBeep() { const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.value = 900; gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15); osc.start(); osc.stop(audioCtx.currentTime + 0.15); }
        function playFlatline() { if(flatlineOsc) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.value = 800; gain.gain.setValueAtTime(0.1, audioCtx.currentTime); osc.start(); flatlineOsc = osc; }
        function stopAllAudio() { if(beepInterval) { clearInterval(beepInterval); beepInterval = null; } if(flatlineOsc) { try { flatlineOsc.stop(); } catch(e){} flatlineOsc = null; } }

        /* --- DATA --- */
        const DB_MATERIEL_BASE = ["Garrot", "Bandage", "Poche de transfusion", "Attelle", "Morphine", "√âpin√©phrine", "Pansement 3 c√¥t√©s"];
        const MEMBRES = ["Bras Gauche", "Bras Droit", "Jambe Gauche", "Jambe Droite"];
        
        const DB_REGLES = {
            classique: [
                { id: "c1", titre: "DCD", zone: "T√™te ou Torse", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "c2", titre: "Inconscient", zone: "Torse", gravite: "Critique", effet: "30s massage + Poche", matos: ["Poche de transfusion"] },
                { id: "c3", titre: "H√©morragie", typeZone: "membre", gravite: "Critique", effet: "Garrot + Poche", matos: ["Garrot", "Bandage", "Poche de transfusion"] },
                { id: "c4", titre: "Saignement", typeZone: "membre", gravite: "Grave", effet: "Bandage + Poche", matos: ["Bandage", "Poche de transfusion"] },
                { id: "c5", titre: "Fracture", typeZone: "membre", gravite: "Grave", effet: "Attelle", matos: ["Bandage", "Attelle"] },
                { id: "c6", titre: "√âraflure", typeZone: "membre", gravite: "L√©g√®re", effet: "Bandage", matos: ["Bandage"] },
                { id: "a12", titre: "Choc Casque", zone: "T√™te", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] },
                { id: "a13", titre: "Choc Gilet", zone: "Torse", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] }
            ],
            avance: [
                { id: "a1", titre: "DCD", zone: "T√™te", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "a2", titre: "DCD", zone: "Torse", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "a3", titre: "Inconscient", zone: "Torse", gravite: "Critique", effet: "Bandage + Massage + √âpi + Poche", matos: ["Bandage", "√âpin√©phrine", "Poche de transfusion"] },
                { id: "a4", titre: "Plaie soufflante", zone: "Torse", gravite: "Critique", effet: "Pnsmt 3 c√¥t√©s + Morphine + Poche", matos: ["Pansement 3 c√¥t√©s", "Morphine", "Poche de transfusion"] },
                { id: "a5", titre: "H√©morragie", typeZone: "membre", gravite: "Critique", effet: "Garrot + Bandage + Morphine + Poche", matos: ["Garrot", "Bandage", "Morphine", "Poche de transfusion"] },
                { id: "a6", titre: "Saignement grave", typeZone: "membre", gravite: "Grave", effet: "Bandage + Morphine", matos: ["Bandage", "Morphine"] },
                { id: "a7", titre: "Saignement", typeZone: "membre", gravite: "Grave", effet: "Bandage", matos: ["Bandage"] },
                { id: "a8", titre: "Fracture", typeZone: "membre", gravite: "Grave", effet: "Bandage + Attelle + Morphine", matos: ["Bandage", "Attelle", "Morphine"] },
                { id: "a9", titre: "√âraflure", typeZone: "membre", gravite: "L√©g√®re", effet: "Bandage", matos: ["Bandage"] },
                { id: "a10", titre: "Prot. Balistique", zone: "T√™te", gravite: "Sp√©cial", effet: "Si Prot: Rien. Sinon: √âraflure (Bandage)", matos: [] },
                { id: "a11", titre: "Prot. Balistique", zone: "Torse", gravite: "Sp√©cial", effet: "Si Prot: H√©matome (Morphine). Sinon: Bandage", matos: ["Morphine", "Bandage"] },
                { id: "a12", titre: "Choc Casque", zone: "T√™te", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] },
                { id: "a13", titre: "Choc Gilet", zone: "Torse", gravite: "Sp√©cial", effet: "Si Prot: Sonn√© (Relev√©). Sinon: DCD", matos: [] }
            ],
            explosion: [
                { id: "e1", titre: "DCD (Blast)", zone: "T√™te", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "e2", titre: "DCD (Blast)", zone: "Torse", gravite: "D√âC√àS", effet: "Respawn direct", matos: [] },
                { id: "e3", titre: "Inconscient", zone: "Torse", gravite: "Critique", effet: "Bandage + 30s Massage + √âpi + Poche", matos: ["Bandage", "√âpin√©phrine", "Poche de transfusion"] },
                { id: "e4", titre: "Plaie Soufflante", zone: "Torse", gravite: "Critique", effet: "Pnsmt 3 c√¥t√©s + Morphine + Poche", matos: ["Pansement 3 c√¥t√©s", "Morphine", "Poche de transfusion"] },
                { id: "e5", titre: "H√©morragie Massive", typeZone: "membre", gravite: "Critique", effet: "Garrot + Bandage + Morphine + Poche", matos: ["Garrot", "Bandage", "Morphine", "Poche de transfusion"] },
                { id: "e6", titre: "Saignement Grave", typeZone: "membre", gravite: "Grave", effet: "Bandage + Morphine", matos: ["Bandage", "Morphine"] },
                { id: "e7", titre: "Saignement", typeZone: "membre", gravite: "Grave", effet: "Bandage", matos: ["Bandage"] },
                { id: "e8", titre: "Fracture Ouverte", typeZone: "membre", gravite: "Grave", effet: "Bandage + Attelle + Morphine", matos: ["Bandage", "Attelle", "Morphine"] },
                { id: "e9", titre: "√âraflure (√âclat)", typeZone: "membre", gravite: "L√©g√®re", effet: "Bandage", matos: ["Bandage"] },
                { id: "e10", titre: "Prot. Balistique", zone: "T√™te", gravite: "Sp√©cial", effet: "Prot√©g√©: Rien. Sinon: √âraflure", matos: [] },
                { id: "e11", titre: "Prot. Balistique", zone: "Torse", gravite: "Sp√©cial", effet: "Prot√©g√©: H√©matome. Sinon: Bandage", matos: ["Morphine", "Bandage"] },
                { id: "e12", titre: "Souffle (Casque)", zone: "T√™te", gravite: "Sp√©cial", effet: "Prot√©g√©: Sonn√©. Sinon: DCD", matos: [] },
                { id: "e13", titre: "Souffle (Gilet)", zone: "Torse", gravite: "Sp√©cial", effet: "Prot√©g√©: Sonn√©. Sinon: DCD", matos: [] }
            ]
        };

        /* --- STATE --- */
        let appState = { 
            mode: "classique", explosionEnabled: false, deathRisk: false,
            materiel: {}, quantites: {}, customDecks: [], customMaterials: [],
            playerName: "Joueur", playerTeamId: "blue", isOrga: false,
            customTeams: [{id:'blue',name:'Bleu',color:'#1976d2'},{id:'red',name:'Rouge',color:'#d32f2f'}]
        };

        let peer = null; let myConn = null; let hostConns = {}; let playersData = {};
        let timerLogic = null; let isTimerActive = false;

        /* --- INIT --- */
        window.onload = function() {
            if(localStorage.getItem('medic_v32_smart')) appState = JSON.parse(localStorage.getItem('medic_v32_smart'));
            initDefaults(); updateUI_Game();
        };

        function initDefaults() {
            const allItems = [...DB_MATERIEL_BASE, ...(appState.customMaterials || [])];
            allItems.forEach(m => { if(appState.materiel[m]===undefined) appState.materiel[m]=true; });
            ["classique","avance","explosion"].forEach(m => { 
                if(DB_REGLES[m]) DB_REGLES[m].forEach(r => {
                    let rid = r.id || (m+"_"+r.titre);
                    if(!appState.quantites[rid]) appState.quantites[rid]=2;
                });
            });
        }

        /* --- NAVIGATION --- */
        function showScreen(id) { document.querySelectorAll('.screen, .flex-center').forEach(e => e.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function retourAccueil() { 
            stopAllAudio(); clearInterval(timerLogic); isTimerActive=false;
            document.getElementById('death-overlay').style.display='none';
            document.getElementById('danger-zone-container').style.display='none';
            showScreen('screen-game'); 
        }
        
        /* --- GAME LOGIC --- */
        function lancerSequenceTirage(src) {
            initAudio();
            const card = preparerTirage(src);
            if(!card) return;
            showScreen('screen-march');
            const march = document.querySelector('.march-list');
            march.innerHTML = march.innerHTML;
            setTimeout(() => { afficherResultat(card); }, 4000);
        }

        function preparerTirage(src) {
            let rules = [];
            if(src==='explosion') rules = DB_REGLES.explosion;
            else if(src==='bille') rules = (appState.mode.startsWith('d_')) ? appState.customDecks.find(d=>d.id===appState.mode).cards : DB_REGLES[appState.mode];
            else rules = appState.customDecks.find(d=>d.id===src).cards;

            let pool = [];
            rules.forEach(r => { 
                let rid=r.id||(appState.mode+"_"+r.titre);
                if(src==='explosion') rid=r.id;
                let q=appState.quantites[rid];
                if(q>0 && r.matos.every(m=>appState.materiel[m])) { for(let i=0;i<q;i++) pool.push(r); } 
            });
            
            if(pool.length===0) { alert("Aucune carte disponible. V√©rifiez que vous avez le mat√©riel requis (R√©glages)."); return null; }
            return pool[Math.floor(Math.random()*pool.length)];
        }

        function afficherResultat(card) {
            document.getElementById('badge-gravite').innerText=card.gravite;
            const col = getColor(card.gravite);
            document.getElementById('badge-gravite').style.backgroundColor = col;
            document.getElementById('ui-card').style.borderColor = col;
            document.getElementById('ui-card').style.boxShadow = `0 0 50px ${col}60`;
            document.getElementById('btn-card').style.backgroundColor = col;
            document.getElementById('txt-titre').innerText=card.titre;
            let z = card.zone; if(card.typeZone==='membre') z = MEMBRES[Math.floor(Math.random()*4)];
            document.getElementById('txt-zone').innerText=z;
            document.getElementById('txt-soins').innerText=card.effet;
            showScreen('screen-result');

            if(appState.deathRisk && card.gravite === "Critique" && card.gravite !== "D√âC√àS") {
                if(Math.random() < 0.40) activerTimerMort();
            }
        }

        function activerTimerMort() {
            isTimerActive = true;
            document.getElementById('danger-zone-container').style.display = "block";
            const btn = document.getElementById('btn-card');
            btn.innerText = "SOINS EFFECTU√âS (SAUVER)";
            btn.style.backgroundColor = "#d32f2f";
            beepInterval = setInterval(playBeep, 1000);
            let duree = 30 + Math.random() * 30;
            timerLogic = setInterval(() => { duree -= 0.1; if(duree <= 0) { clearInterval(timerLogic); mortDuPatient(); } }, 100);
        }

        function mortDuPatient() {
            isTimerActive = false; stopAllAudio(); playFlatline();
            document.getElementById('death-overlay').style.display = "flex";
        }
        
        function actionPrincipale() {
            if(isTimerActive) { clearInterval(timerLogic); stopAllAudio(); isTimerActive = false; alert("PATIENT STABILIS√â !"); retourAccueil(); }
            else { retourAccueil(); }
        }

        function getColor(g) {
            if(g==="D√âC√àS") return "#000";
            if(g==="Critique") return "#d32f2f";
            if(g==="Grave") return "#f57c00";
            if(g==="L√©g√®re") return "#388e3c";
            return "#7b1fa2";
        }

        /* --- SETTINGS (SMART DISPLAY) --- */
        function ouvrirReglages() { 
            const s=document.getElementById('select-mode'); s.innerHTML=`<option value="classique">CLASSIQUE</option><option value="avance">AVANC√â</option>`;
            appState.customDecks.forEach(d=>s.innerHTML+=`<option value="${d.id}">${d.name} (Custom)</option>`);
            s.value=appState.mode; 
            document.getElementById('chk-death').checked = appState.deathRisk;
            renderSettingsList(); showScreen('screen-settings'); 
        }

        function renderSettingsList() {
            // 1. Identify Active Rules
            let activeRules = [];
            if(appState.mode.startsWith('d_')) {
                const d = appState.customDecks.find(d=>d.id===appState.mode);
                if(d) activeRules = d.cards;
            } else {
                activeRules = DB_REGLES[appState.mode] || [];
            }
            if(appState.mode==='avance' && appState.explosionEnabled) {
                activeRules = [...activeRules, ...DB_REGLES.explosion];
            }

            // 2. Identify Required Materials
            let requiredMatos = new Set();
            activeRules.forEach(r => {
                if(r.matos && Array.isArray(r.matos)) {
                    r.matos.forEach(m => requiredMatos.add(m));
                }
            });

            // 3. Render Material Checkboxes (Filtered)
            const lm = document.getElementById('liste-materiel'); 
            lm.innerHTML = "";
            const allPossibleMaterials = [...new Set([...DB_MATERIEL_BASE, ...(appState.customMaterials || [])])];
            
            let matosShownCount = 0;
            allPossibleMaterials.forEach(m => { 
                // Only show if required by current rules
                if(requiredMatos.has(m)) {
                    if(appState.materiel[m]===undefined) appState.materiel[m]=true;
                    lm.innerHTML += `<div class="check-item"><span>${m}</span><input type="checkbox" onchange="appState.materiel['${m}']=this.checked" ${appState.materiel[m]?'checked':''}></div>`; 
                    matosShownCount++;
                }
            });
            if(matosShownCount === 0) {
                lm.innerHTML = "<div style='color:#666; font-style:italic; padding:10px;'>Aucun mat√©riel requis pour ce mode.</div>";
            }
            
            document.getElementById('box-explosion-opt').style.display=(appState.mode==='avance')?'block':'none';
            document.getElementById('chk-explosion').checked=appState.explosionEnabled;

            // 4. Render Rules List (Standard)
            const lr=document.getElementById('liste-regles'); lr.innerHTML="";
            
            // Re-fetch base rules for splitting logic
            let baseRules = (appState.mode.startsWith('d_')) ? appState.customDecks.find(d=>d.id===appState.mode).cards : DB_REGLES[appState.mode];
            if(!baseRules) baseRules=[];
            
            let total = 0;
            const renderRow = (r) => {
                let rid = r.id || (appState.mode + "_" + r.titre);
                if(r.id && r.id.startsWith('e')) rid = r.id; 
                if (appState.quantites[rid] === undefined) appState.quantites[rid] = 2;
                let q = appState.quantites[rid];
                // Check against global material state
                let matosOk = r.matos.every(m => appState.materiel[m]);
                if (matosOk) total += q;

                lr.innerHTML += `
                    <div class="check-item" style="opacity:${matosOk ? 1 : 0.5}">
                        <div style="flex-grow:1"><strong style="color:${getColor(r.gravite)}">${r.titre}</strong></div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="btn-mini" style="background:#1976d2" onclick="voirDetails('${rid}','${appState.mode}')">üëÅÔ∏è</button>
                            <button class="btn-mini" onclick="changeQty('${rid}',-1)">-</button>
                            <span style="width:20px;text-align:center">${q}</span>
                            <button class="btn-mini" onclick="changeQty('${rid}',1)">+</button>
                        </div>
                    </div>`;
            };

            baseRules.forEach(r => renderRow(r));
            if (appState.mode === 'avance' && appState.explosionEnabled) {
                lr.innerHTML += `<div class="separator">üí• PACK EXPLOSION</div>`;
                DB_REGLES.explosion.forEach(r => renderRow(r));
            }
            document.getElementById('info-deck').innerText = total + " cartes actives";
        }
        
        function voirDetails(rid, mode) {
            let rules=(mode.startsWith('d_'))?appState.customDecks.find(d=>d.id===mode).cards:DB_REGLES[mode];
            if(mode==='avance' && appState.explosionEnabled) rules=[...rules, ...DB_REGLES.explosion];
            const r = rules.find(x => (x.id === rid) || ((mode+"_"+x.titre) === rid));
            if(!r) return;
            const modal = document.getElementById('previewModal');
            document.getElementById('preview-body').innerHTML = `
                <div class="preview-card-mini" style="border-left-color:${getColor(r.gravite)}">
                    <h4 style="color:${getColor(r.gravite)}; margin:0;">${r.gravite}</h4>
                    <p><strong>${r.titre}</strong></p>
                    <p style="font-size:0.9em;">${r.effet}</p>
                    <p style="font-size:0.8em; color:#888;">Matos: ${r.matos.join(', ')}</p>
                </div>`;
            modal.style.display='block';
        }

        function changeQty(id, d) { appState.quantites[id] = Math.max(0, appState.quantites[id]+d); renderSettingsList(); }
        function changerModeMenu(v) { appState.mode=v; renderSettingsList(); }
        function toggleDeathRisk() { appState.deathRisk = document.getElementById('chk-death').checked; }
        function toggleExplosion() { appState.explosionEnabled=document.getElementById('chk-explosion').checked; renderSettingsList(); }
        function sauvegarderEtQuitter() { saveState(); if(appState.isOrga) broadcastConfig(); retourAccueil(); }
        function annulerReglages() { retourAccueil(); }

        /* --- BUILDER --- */
        let currentDeckId = null; let currentCardIndex = -1; let tempMatos = [];
        function ouvrirBuilder() { showScreen('screen-builder'); renderDecksList(); }
        function creerNouveauPaquet() { let id="d_"+Date.now(); appState.customDecks.push({id:id, name:"Nouveau", showOnHome:true, cards:[]}); editDeck(id); }
        function renderDecksList() { const l=document.getElementById('custom-decks-list'); l.innerHTML=""; appState.customDecks.forEach(d=>{ l.innerHTML+=`<div class="builder-item"><span>${d.name}</span><button class="header-btn" onclick="editDeck('${d.id}')">‚úèÔ∏è</button></div>`; }); }
        function editDeck(id) { currentDeckId=id; const d=appState.customDecks.find(x=>x.id===id); document.getElementById('deck-name').value=d.name; document.getElementById('deck-show-home').checked=d.showOnHome; renderCardsList(d); showScreen('screen-deck-edit'); }
        function renderCardsList(d) { const l=document.getElementById('deck-cards-list'); l.innerHTML=""; d.cards.forEach((c,i)=>{ l.innerHTML+=`<div class="builder-item"><span>${c.titre}</span><button class="btn-mini" onclick="editCard(${i})">‚úèÔ∏è</button></div>`; }); }
        function sauvegarderPaquetCourant() { const d=appState.customDecks.find(x=>x.id===currentDeckId); d.name=document.getElementById('deck-name').value; d.showOnHome=document.getElementById('deck-show-home').checked; saveState(); ouvrirBuilder(); }
        function supprimerPaquetCourant() { appState.customDecks = appState.customDecks.filter(x=>x.id!==currentDeckId); saveState(); ouvrirBuilder(); }
        function ajouterCarteCustom() { currentCardIndex=-1; document.getElementById('card-title').value=""; tempMatos=[]; showScreen('screen-card-edit'); renderMatosCheck(); }
        function editCard(i) { currentCardIndex=i; const c=appState.customDecks.find(x=>x.id===currentDeckId).cards[i]; document.getElementById('card-title').value=c.titre; document.getElementById('card-gravity').value=c.gravite; document.getElementById('card-zone').value=c.zone; document.getElementById('card-effect').value=c.effet; tempMatos=[...c.matos]; renderMatosCheck(); showScreen('screen-card-edit'); }
        
        function renderMatosCheck() { 
            const l = document.getElementById('card-matos-list'); 
            l.innerHTML = "";
            const allMatos = [...new Set([...DB_MATERIEL_BASE, ...(appState.customMaterials || [])])];
            allMatos.forEach(m => { 
                l.innerHTML += `<div class="check-item"><input type="checkbox" onchange="toggleMatos('${m}')" ${tempMatos.includes(m)?'checked':''}> ${m}</div>`; 
            }); 
        }
        function toggleMatos(m) { if(tempMatos.includes(m)) tempMatos=tempMatos.filter(x=>x!==m); else tempMatos.push(m); }
        
        function ajouterNouveauMatos() {
            const val = document.getElementById('new-matos-name').value.trim();
            if(!val) return;
            if(!appState.customMaterials) appState.customMaterials = [];
            if(!appState.customMaterials.includes(val) && !DB_MATERIEL_BASE.includes(val)) {
                appState.customMaterials.push(val);
                if(!tempMatos.includes(val)) tempMatos.push(val);
                saveState();
                renderMatosCheck();
            }
            document.getElementById('new-matos-name').value = "";
        }

        function validerCarte() { 
            const nc={ titre:document.getElementById('card-title').value, gravite:document.getElementById('card-gravity').value, zone:document.getElementById('card-zone').value, effet:document.getElementById('card-effect').value, matos:tempMatos, typeZone:'custom' };
            const d=appState.customDecks.find(x=>x.id===currentDeckId); if(currentCardIndex===-1) d.cards.push(nc); else d.cards[currentCardIndex]=nc;
            editDeck(currentDeckId);
        }
        function annulerEditionCarte() { editDeck(currentDeckId); }

        /* --- MULTIJOUEUR PEERJS --- */
        function ouvrirMenuMultijoueur() { 
            if(appState.isOrga && peer) { showScreen('screen-host-dashboard'); updateDashboard(); } 
            else { document.getElementById('multiplayerModal').style.display='block'; document.getElementById('multi-pseudo').value=appState.playerName; }
        }
        function fermerMultiModal() { document.getElementById('multiplayerModal').style.display='none'; }
        function creerPartieEnLigne() {
            appState.playerName = document.getElementById('multi-pseudo').value || "Orga"; appState.isOrga = true; appState.playerTeamId="orga";
            document.getElementById('multi-status').style.display='block';
            peer = new Peer("MEDIC-" + Math.floor(1000 + Math.random() * 9000));
            peer.on('open', (id) => {
                document.getElementById('host-connection-id').innerText = id;
                fermerMultiModal(); showScreen('screen-host-dashboard'); updateDashboard();
                saveState();
            });
            peer.on('connection', (conn) => {
                conn.on('data', (d) => handleHostData(conn, d));
                conn.on('close', () => { delete hostConns[conn.peer]; delete playersData[conn.peer]; updateDashboard(); });
                hostConns[conn.peer] = conn;
            });
        }
        function rejoindrePartieEnLigne() {
            const code = document.getElementById('join-code').value.toUpperCase();
            appState.playerName = document.getElementById('multi-pseudo').value || "Joueur"; appState.isOrga = false;
            peer = new Peer();
            peer.on('open', () => {
                myConn = peer.connect(code);
                myConn.on('open', () => { myConn.send({type:'JOIN', name:appState.playerName}); document.getElementById('btn-multi-icon').classList.add('online'); fermerMultiModal(); alert("Connect√© !"); });
                myConn.on('data', (d) => handleClientData(d));
            });
        }
        function handleHostData(conn, data) {
            if(data.type === 'JOIN') {
                playersData[conn.peer] = { id: conn.peer, name: data.name, teamId: 'blue', isOrga: false };
                broadcastConfig(); updateDashboard();
            }
        }
        function handleClientData(data) {
            if(data.type === 'SYNC_CONFIG') { appState.mode = data.mode; appState.customDecks = data.decks; updateUI_Game(); }
            if(data.type === 'CMD_TEAM') { appState.playerTeamId = data.teamId; updateUI_Game(); alert("Changement d'√©quipe !"); }
        }
        function broadcastConfig() { Object.values(hostConns).forEach(c => c.send({type:'SYNC_CONFIG', mode:appState.mode, decks:appState.customDecks})); }
        function updateDashboard() {
            const l = document.getElementById('host-player-list'); l.innerHTML="";
            document.getElementById('connected-count').innerText = Object.keys(playersData).length;
            Object.values(playersData).forEach(p => {
                const team = appState.customTeams.find(t=>t.id===p.teamId);
                let btns = ""; appState.customTeams.forEach(t => btns += `<button class="btn-dash" style="border-color:${t.color}" onclick="cmdTeam('${p.id}','${t.id}')">${t.name}</button>`);
                l.innerHTML += `<div class="player-row" style="border-left:4px solid ${team.color}">
                    <div class="player-row-header"><strong>${p.name}</strong> <span style="color:${team.color}">${team.name}</span></div>
                    <div class="player-actions">${btns} <button class="btn-dash" style="background:#d32f2f" onclick="cmdKick('${p.id}')">Kick</button></div>
                </div>`;
            });
        }
        function cmdTeam(pid, tid) { playersData[pid].teamId = tid; hostConns[pid].send({type:'CMD_TEAM', teamId:tid}); updateDashboard(); }
        function cmdKick(pid) { hostConns[pid].close(); delete hostConns[pid]; delete playersData[pid]; updateDashboard(); }

        /* --- UI & GAME --- */
        function updateUI_Game() {
            const team = appState.customTeams.find(t=>t.id===appState.playerTeamId);
            document.getElementById('main-header').style.borderBottomColor = team.color;
            document.getElementById('top-indicator').innerText = `${appState.playerName} | ${team.name}`;
            const c = document.getElementById('dynamic-buttons-container'); c.innerHTML="";
            c.innerHTML += `<div class="btn-container-shared"><div class="pulse-ring"></div><button class="btn-core-shared main-btn" onclick="lancerSequenceTirage('bille')"><img src="picto-blesse.png" class="icon-wounded"></button><div class="btn-label">BALISTIQUE</div></div>`;
            if(appState.mode==='avance' && appState.explosionEnabled) c.innerHTML += `<div class="btn-container-shared"><div class="pulse-ring-blast"></div><button class="btn-core-shared blast-btn" onclick="lancerSequenceTirage('explosion')"><img src="btn-explosion.png" class="icon-blast"></button><div class="btn-label">EXPLOSION</div></div>`;
            appState.customDecks.forEach(d => { if(d.showOnHome) c.innerHTML += `<div class="btn-container-shared"><div class="pulse-ring-custom"></div><button class="btn-core-shared custom-btn-style" onclick="lancerSequenceTirage('${d.id}')"><img src="btn-custom.png" class="icon-custom" onerror="this.src='picto-blesse.png'"></button><div class="btn-label">${d.name}</div></div>`; });
        }
        function saveState() { localStorage.setItem('medic_v32_smart', JSON.stringify(appState)); updateUI_Game(); }

    </script>
</body>
</html>
